# Story 2.4: Profile Avatar Upload

**Status:** Ready for Review

## Story

**As a** user,
**I want** to upload my profile photo,
**so that** my card và website có professional appearance.

## Acceptance Criteria

1. ✅ Frontend có upload area với drag & drop support
2. ✅ Clicking upload area opens file picker (accept: image/jpeg, image/png)
3. ✅ Image preview displayed immediately after selection
4. ✅ Client-side validation: file size max 5MB, dimensions min 200x200px
5. ✅ POST /api/v1/profiles/upload-avatar endpoint accepts multipart/form-data
6. ✅ Backend uses Multer middleware cho file handling
7. ✅ Image processed với Sharp: resize to 500x500px, optimize quality
8. ✅ File saved to local storage (dev) hoặc uploaded to cloud (prod)
9. ✅ Returns avatar URL: { avatarUrl: "https://..." }
10. ✅ Cropping tool (react-image-crop) allows user to crop image before upload
11. ✅ Error handling: file too large, invalid format, upload failed

## Tasks / Subtasks

- [x] Task 1: Backend - Multer configuration (AC: 5, 6)
  - [x] Create uploads/ directory structure
  - [x] Configure multer for multipart/form-data
  - [x] File filter for JPEG/PNG only
  - [x] Size limit 5MB
- [x] Task 2: Backend - Image processing with Sharp (AC: 7, 8)
  - [x] Create profile.controller.js
  - [x] uploadAvatar handler
  - [x] Resize to 500x500px
  - [x] Optimize quality (80%)
  - [x] Save to uploads/avatars/ directory
- [x] Task 3: Backend - Routes (AC: 5, 9)
  - [x] Create profile.routes.js
  - [x] POST /api/v1/profiles/upload-avatar
  - [x] Return avatarUrl in response
  - [x] Error handling middleware
- [x] Task 4: Frontend - Avatar Upload Component (AC: 1, 2, 3, 4)
  - [x] Create AvatarUpload.jsx
  - [x] Drag & drop zone
  - [x] File picker on click
  - [x] Image preview
  - [x] Client-side validation (size, dimensions)
- [x] Task 5: Frontend - Image Cropping (AC: 10)
  - [x] Integrate react-image-crop
  - [x] Crop modal before upload
  - [x] Preview cropped image
- [x] Task 6: Frontend - Upload to Backend (AC: 9, 11)
  - [x] axios POST with FormData
  - [x] Upload progress indicator
  - [x] Error handling
  - [x] Update Zustand store with avatarUrl
- [x] Task 7: Integration
  - [x] Add AvatarUpload to wizard (can upload anytime)
  - [x] Update backend index.js with profile routes
  - [x] Test end-to-end upload flow

## Dev Notes

### Implementation Details
- Avatar can be uploaded at any step in wizard
- AvatarUpload component can be used standalone
- Image cropping optional but recommended
- Sharp processes images server-side for consistency
- Unique filenames using timestamp + random string
- CORS configured to allow multipart uploads

### Technical Decisions
- Multer for file handling (industry standard)
- Sharp for image processing (fast, memory efficient)
- react-image-crop for client-side cropping
- Store avatars in uploads/avatars/ directory
- Return relative URL path from server
- Client constructs full URL with backend base URL

### File Structure
```
backend/
├── uploads/
│   └── avatars/
│       └── [uploaded files]
├── src/
│   ├── controllers/
│   │   └── profile.controller.js
│   └── routes/
│       └── profile.routes.js

frontend/
└── src/
    └── components/
        └── wizard/
            └── AvatarUpload.jsx
```

## Testing

### Manual Testing Steps
1. Navigate to any wizard step
2. See avatar upload area
3. Drag image file - see preview
4. Click upload area - file picker opens
5. Select image > 5MB - see error
6. Select valid image < 5MB
7. Crop tool opens - adjust crop
8. Click upload - progress indicator
9. Upload complete - avatar displays
10. Check backend uploads/avatars/ - file saved
11. Refresh page - avatar persists (from zustand)

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes
- Full avatar upload implementation complete
- Client-side and server-side validation working
- Image cropping functional
- Sharp processing optimizes images
- Error handling comprehensive
- Files stored in uploads/avatars/

### File List
- backend/src/controllers/profile.controller.js (created)
- backend/src/routes/profile.routes.js (created)
- backend/src/index.js (modified - added profile routes)
- frontend/src/components/wizard/AvatarUpload.jsx (created)
- docs/stories/2.4.avatar-upload.md (created)

### Change Log
1. Created Multer configuration with file size and type validation
2. Implemented Sharp image processing (resize, optimize)
3. Created profile controller with uploadAvatar handler
4. Created profile routes with error handling
5. Built AvatarUpload component with drag & drop
6. Integrated react-image-crop for cropping
7. Added client-side validation (size, dimensions, format)
8. Implemented upload progress indicator
9. Added comprehensive error handling
10. Integrated with Zustand store for avatar URL persistence