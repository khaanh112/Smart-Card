# Story 4.2: Profile Editing Form

**Epic:** 4 - Profile Management Dashboard  
**Status:** ✅ Completed  
**Assigned To:** Dev Agent (James)  
**Created:** December 2, 2025

---

## Story

**As a** user,  
**I want** to edit my profile information,  
**so that** I can keep my profile up-to-date.

---

## Acceptance Criteria

- [x] Clicking "Edit" navigates to /dashboard/profiles/:profileId/edit
- [x] Form pre-populated with existing profile data from database
- [x] Same form fields as creation wizard (personal info, work experience, social links)
- [x] Avatar update: can upload new photo or keep existing
- [x] PUT /api/v1/profiles/:profileId endpoint updates profile
- [x] Validation: same rules as creation form
- [x] Changes saved to database via Prisma transaction
- [x] Success message: "Profile updated successfully"
- [x] "Cancel" button returns to dashboard without saving
- [x] Unsaved changes warning when navigating away

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Tasks
- [x] Add getProfileById controller function
- [x] Add GET /:profileId/edit route (authenticated)
- [x] Create EditProfile.jsx page component
- [x] Fetch profile data and populate wizard store
- [x] Reuse wizard components (PersonalInfoStep, WorkExperienceStep, etc.)
- [x] Implement onChange tracking for unsaved changes
- [x] Add Save/Cancel buttons with sticky header
- [x] Implement PUT endpoint call with transaction
- [x] Add beforeunload warning for unsaved changes
- [x] Add route to App.jsx
- [x] Update wizard components to support onChange prop

### Completion Notes
✅ **Profile Editing Form Fully Implemented**

**Backend Implementation:**
- Added `getProfileById` controller function
  - Fetches profile with all relations (experiences, socialLinks, theme)
  - Verifies user ownership
  - Returns complete profile data for editing
- Added GET route: `/api/v1/profiles/:profileId/edit` (authenticated)
- Updated exports in profile.routes.js
- Existing `updateProfile` endpoint already handles updates with transaction

**Frontend Implementation:**
- Created `/frontend/src/pages/EditProfile.jsx` - full-featured edit page
- Features:
  - Fetches profile data on mount
  - Populates Zustand wizard store with existing data
  - Reuses all wizard components (PersonalInfoStep, WorkExperienceStep, SocialLinksStep, ThemeSelectionStep, AvatarUpload)
  - Tracks unsaved changes with `hasChanges` state
  - Sticky header with Save/Cancel buttons
  - "Unsaved changes" indicator in header
  - beforeunload warning when leaving with unsaved changes
  - Cancel confirmation dialog
  - Loading skeleton during fetch
  - Error handling with redirect

**Wizard Components Updates:**
- Updated PersonalInfoStep to accept onChange prop
  - Watches form fields and calls onChange on any change
- Updated WorkExperienceStep, SocialLinksStep, ThemeSelectionStep to accept onChange prop
  - Calls onChange after add/update/delete operations
- AvatarUpload already works (direct store mutation triggers parent re-render)
- All components remain backward compatible (onChange is optional)

**Edit Page Layout:**
- Sticky header with profile title and action buttons
- Sections organized in cards:
  1. Personal Information
  2. Profile Photo
  3. Work Experience
  4. Social Links
  5. Theme Selection
- Bottom action bar with Cancel/Save buttons
- Responsive design

**UX Features:**
- "Unsaved changes" text appears in header when form is dirty
- Save button disabled until changes made
- Cancel button shows confirmation if unsaved changes
- Browser warning on page close/refresh with unsaved changes
- Success alert and redirect to dashboard after save
- Error messages displayed prominently
- Loading state while fetching profile data

**Data Flow:**
1. Load: Fetch profile → Populate wizard store
2. Edit: User modifies → onChange called → hasChanges = true
3. Save: Collect data from store → PUT to API → Success → Navigate to dashboard
4. Cancel: Check hasChanges → Confirm → Navigate to dashboard

### Debug Log References
No major issues. Wizard components already well-structured for reuse.

### File List
**New Files:**
- `frontend/src/pages/EditProfile.jsx`
- `docs/stories/4.2.profile-editing.md`

**Modified Files:**
- `backend/src/controllers/profile.controller.js` - Added getProfileById function
- `backend/src/routes/profile.routes.js` - Added GET /:profileId/edit route
- `frontend/src/App.jsx` - Added EditProfile route
- `frontend/src/components/wizard/PersonalInfoStep.jsx` - Added onChange support
- `frontend/src/components/wizard/WorkExperienceStep.jsx` - Added onChange support
- `frontend/src/components/wizard/SocialLinksStep.jsx` - Added onChange support
- `frontend/src/components/wizard/ThemeSelectionStep.jsx` - Added onChange support

### Change Log
- 2025-12-02 15:02: Created EditProfile.jsx component
- 2025-12-02 15:03: Added getProfileById controller function
- 2025-12-02 15:04: Added edit route to backend
- 2025-12-02 15:05: Added EditProfile route to App.jsx
- 2025-12-02 15:06: Updated PersonalInfoStep with onChange
- 2025-12-02 15:07: Updated other wizard components with onChange
- 2025-12-02 15:09: Created story documentation

---

## Testing Notes

**Manual Testing Steps:**
1. Login and go to Dashboard
2. Click "Edit" button on any profile card
3. Verify all fields pre-populated correctly:
   - Personal info (name, title, phone, address)
   - Avatar displayed if exists
   - Work experiences list
   - Social links list
   - Theme selected
4. Make a change → Verify "Unsaved changes" appears in header
5. Try to leave page → Browser shows warning
6. Click Cancel → Shows confirmation dialog
7. Make changes and click Save → Success message → Redirects to dashboard
8. Edit again → Verify changes persisted

**Edge Cases:**
- Profile not found or unauthorized → Redirects to dashboard
- No auth token → Redirects to login
- Network error during save → Shows error message
- Invalid data → Form validation prevents submission

---

## Next Steps

**Future Enhancements:**
- Automatically regenerate QR code if slug changes (currently slug is immutable)
- Show preview of profile with changes before saving
- Add "Discard Changes" button
- Auto-save draft while editing
- History/version control for profile changes

---

## Notes

- Reused wizard components for consistency
- Wizard store serves as shared state between create and edit flows
- onChange prop is optional - wizard works in both modes
- Edit page layout different from wizard (single page vs stepper)
- All validation rules same as create wizard
- Theme change doesn't require card regeneration (cards generated in Epic 3)
- Profile slug cannot be changed (would break existing URLs/QR codes)
- Avatar upload uses same endpoint as wizard
