# Story 2.7: Payment Integration - VNPay

**Status:** Ready for Review

---

## Story

**As a** user,
**I want** to pay for my profile creation via VNPay,
**so that** I can complete my order and receive deliverables.

## Acceptance Criteria

1. ✅ Payment screen shows order summary: Profile creation, Price, Selected theme
2. ✅ POST /api/v1/payments/create endpoint creates payment record in database (status: pending)
3. ✅ Generates VNPay payment URL with order details
4. ✅ Redirects user to VNPay payment gateway
5. ✅ VNPay callback URL: /api/v1/payments/vnpay-callback
6. ✅ Callback verifies payment signature with VNPay secret key
7. ✅ If payment successful: update payment record (status: completed), create profile record
8. ✅ If payment failed: update payment record (status: failed), show error message
9. ✅ Successful payment triggers profile generation workflow (ready for Story 2.8)
10. ✅ Returns success URL with payment confirmation

---

## Tasks / Subtasks

- [x] Task 1: VNPay Utility (AC: 3, 6)
  - [x] Create vnpay.js utility in backend/src/utils/
  - [x] Implement generatePaymentUrl() method
  - [x] Implement verifyCallback() signature verification
  - [x] Implement HMAC SHA512 signing
  - [x] Format date to VNPay format (yyyyMMddHHmmss)
  - [x] Handle response codes and error messages

- [x] Task 2: Payment Controller (AC: 2, 5, 7, 8)
  - [x] Create payment.controller.js
  - [x] createPayment() - creates payment record, generates VNPay URL
  - [x] vnpayCallback() - handles VNPay return, updates payment status
  - [x] getPaymentStatus() - returns payment details
  - [x] getPaymentHistory() - returns user's payment history

- [x] Task 3: Payment Routes (AC: 2, 5)
  - [x] Create payment.routes.js
  - [x] POST /api/v1/payments/create (authenticated)
  - [x] GET /api/v1/payments/vnpay-callback (public)
  - [x] GET /api/v1/payments/:paymentId (authenticated)
  - [x] GET /api/v1/payments/history (authenticated)
  - [x] Add Swagger documentation

- [x] Task 4: Frontend Payment Page (AC: 1, 4)
  - [x] Create PaymentPage.jsx
  - [x] Display order summary with price breakdown
  - [x] Show profile preview
  - [x] VNPay payment method selector
  - [x] "Pay Now" button calls /api/v1/payments/create
  - [x] Redirects to VNPay URL

- [x] Task 5: Payment Result Pages (AC: 8, 10)
  - [x] Create PaymentSuccess.jsx
  - [x] Create PaymentFailed.jsx
  - [x] Success page shows payment details and next steps
  - [x] Failed page shows error message and retry option
  - [x] Fetch payment status on success page

- [x] Task 6: Integration (AC: All)
  - [x] Update PreviewStep to navigate to /payment
  - [x] Add payment routes to App.jsx
  - [x] Add payment routes to backend index.js
  - [x] Update .env.example with VNPay credentials

---

## Dev Notes

### Implementation Details

**VNPay Utility (`backend/src/utils/vnpay.js`):**
- HMAC SHA512 signature generation
- Parameter sorting (required by VNPay)
- Payment URL generation with all required fields
- Signature verification for callbacks
- Response code mapping to error messages
- 15-minute payment expiration

**Payment Controller:**
- `createPayment()`: Creates Payment record with PENDING status, stores profileData in metadata
- `vnpayCallback()`: Verifies signature, updates payment status, redirects to success/failed page
- `getPaymentStatus()`: Returns payment details for success page
- `getPaymentHistory()`: Paginated payment history for dashboard

**Frontend Payment Flow:**
1. User confirms preview → navigates to /payment
2. Payment page displays order summary + profile preview
3. Click "Pay Now" → POST /api/v1/payments/create
4. Backend returns VNPay URL → redirect to VNPay gateway
5. User completes payment on VNPay
6. VNPay redirects to /api/v1/payments/vnpay-callback
7. Backend verifies signature, updates payment status
8. Redirect to /payment/success or /payment/failed
9. Success page fetches payment details

**Environment Variables:**
```
VNPAY_TMN_CODE=your-vnpay-tmn-code
VNPAY_HASH_SECRET=your-vnpay-hash-secret
VNPAY_URL=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
VNPAY_RETURN_URL=http://localhost:3000/api/v1/payments/vnpay-callback
```

**Price:**
- Profile creation: 50,000 VND (hardcoded for now)
- Future: Make configurable or add pricing tiers

### File Structure
```
backend/src/
├── utils/
│   └── vnpay.js (NEW - VNPay integration)
├── controllers/
│   └── payment.controller.js (NEW - payment logic)
└── routes/
    └── payment.routes.js (NEW - payment endpoints)

frontend/src/
├── pages/
│   ├── PaymentPage.jsx (NEW - checkout page)
│   ├── PaymentSuccess.jsx (NEW - success page)
│   └── PaymentFailed.jsx (NEW - error page)
└── components/
    └── wizard/
        └── PreviewStep.jsx (modified - navigate to payment)
```

### Dependencies
- crypto (Node.js built-in) - HMAC SHA512
- querystring (Node.js built-in) - URL encoding
- axios (frontend) - API calls
- react-router-dom - navigation

---

## Testing

### Manual Testing Steps

**Backend Testing:**
1. Start backend: `docker-compose up backend`
2. Test payment creation:
   ```bash
   curl -X POST http://localhost:3000/api/v1/payments/create \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "amount": 50000,
       "profileData": { "personalInfo": {...} }
     }'
   ```
3. Copy paymentUrl from response
4. Open URL in browser → should redirect to VNPay sandbox
5. Complete test payment on VNPay
6. Verify callback updates payment status in database

**Frontend Testing:**
1. Complete wizard steps 1-5 (preview)
2. Click "Proceed to Payment" → should navigate to /payment
3. Verify order summary displays correctly
4. Click "Pay Now" → should redirect to VNPay
5. Complete payment:
   - Success case: Use test card that succeeds
   - Failure case: Cancel payment or use declining card
6. Verify redirect to success/failed page
7. Check payment details displayed correctly

**VNPay Sandbox Test Cards:**
- Use VNPay sandbox credentials from their documentation
- Test successful payment flow
- Test failed payment scenarios (insufficient funds, cancelled, etc.)

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes
- Full implementation of Story 2.7 complete
- All acceptance criteria met
- VNPay integration with signature verification
- Payment creation and callback handling
- Frontend payment flow with success/failed pages
- Ready for Story 2.8 (Profile Generation)

### File List
- backend/src/utils/vnpay.js (created)
- backend/src/controllers/payment.controller.js (created)
- backend/src/routes/payment.routes.js (created)
- backend/src/index.js (modified - added payment routes)
- frontend/src/pages/PaymentPage.jsx (created)
- frontend/src/pages/PaymentSuccess.jsx (created)
- frontend/src/pages/PaymentFailed.jsx (created)
- frontend/src/components/wizard/PreviewStep.jsx (modified - navigate to payment)
- frontend/src/App.jsx (modified - added payment routes)
- docs/stories/2.7.vnpay-payment.md (created)

### Change Log
1. Created VNPay utility with signature generation and verification
2. Implemented payment controller with create, callback, status endpoints
3. Created payment routes with authentication
4. Built PaymentPage with order summary and VNPay integration
5. Created PaymentSuccess page with payment details
6. Created PaymentFailed page with error handling
7. Updated PreviewStep to navigate to payment page
8. Added payment routes to App.jsx
9. Integrated payment routes into backend index.js
10. Added VNPay environment variables to .env.example

### Status
Story 2.7 implementation complete. Ready for testing with VNPay sandbox.

**Note:** VNPay sandbox credentials needed for testing. Update .env file with actual credentials.

**Next Story:** Story 2.8 - Profile Generation After Payment